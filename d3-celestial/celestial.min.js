// Copyright 2015 Olaf Frohn https://github.com/ofrohn, see LICENSE
var makeCelestial=function(){function t(t,e){function a(a,r){var o=t([a*=180/Math.PI,r*=180/Math.PI]),i=e([a,r]);return[(1-n)*o[0]+n*i[0],(n-1)*o[1]-n*i[1]]}var n,r=d3.geo.projection(a).scale(1),o=r.center,i=r.translate;return r.alpha=function(a){if(!arguments.length)return n;n=+a;var l=t.center(),c=e.center(),s=t.translate(),u=e.translate();return o([(1-n)*l[0]+n*c[0],(1-n)*l[1]+n*c[1]]),i([(1-n)*s[0]+n*u[0],(1-n)*s[1]+n*u[1]]),r},delete r.translate,delete r.center,r.alpha(0)}function e(t,e){return a(t.map(function(t){return t*W}),e).map(function(t){return t/W})}function a(t,e){var a,n,r,o,i,l,c,s,u,f;return e?(l=t[0],l<0&&(l+=V),c=t[1],l-=e[0],o=e[1],i=e[2],a=Math.sin(c)*Math.sin(o)-Math.cos(c)*Math.cos(o)*Math.cos(l),Math.abs(a)<1e-5&&(a=-Math.cos(c+o)+Math.cos(c)*Math.cos(o)*(1-Math.cos(l))),n=-Math.cos(c)*Math.sin(l),s=0!==a||0!==n?Math.atan2(n,a):l-Math.PI,u=i+s,u>Math.PI&&(u-=V),l%Math.PI==0?(f=c+Math.cos(l)*o,f>G&&(f=Math.PI-f),f<-G&&(f=-Math.PI-f)):(r=Math.sin(c)*Math.cos(o)+Math.cos(c)*Math.sin(o)*Math.cos(l),Math.abs(r)>.99?(f=Math.abs(Math.acos(Math.sqrt(a*a+n*n))),r<0&&(f*=-1)):f=Math.asin(r)),[u,f]):t}function n(t,e){var a=t.getUTCFullYear(),n=t.getUTCMonth()+1,r=t.getUTCDate(),o=t.getUTCHours(),i=t.getUTCMinutes(),l=t.getUTCSeconds();1!=n&&2!=n||(a-=1,n+=12);var c=Math.floor(a/100),s=2-c+Math.floor(c/4),u=Math.floor(365.25*a),f=Math.floor(30.6001*(n+1)),d=s+u+f-730550.5+r+(o+i/60+l/3600)/24,h=d/36525,p=280.46061837+360.98564736629*d+387933e-9*h*h-h*h*h/3871e4+e;if(p>0)for(;p>360;)p-=360;else for(;p<0;)p+=360;return p}function r(t,a){return e(t,B[a])}function o(t,e){if("equatorial"===e)return t;for(var a=B[e],n=t.features,r=0;r<n.length;r++)n[r].geometry.coordinates=i(n[r],a);return t}function i(t,a){var n=[];switch(t.geometry.type){case"Point":n=e(t.geometry.coordinates,a);break;case"LineString":n.push(u(t.geometry.coordinates,a));break;case"MultiLineString":n=f(t.geometry.coordinates,a);break;case"Polygon":n.push(u(t.geometry.coordinates[0],a));break;case"MultiPolygon":n.push(f(t.geometry.coordinates[0],a))}return n}function l(t,e){var a=[];if(!e)return[];y(e)||(e=[e]);for(var n=0;n<e.length;n++)switch(e[n]){case"center":a="lat"===t?a.concat(s(t,T.center[0],"N")):a.concat(s(t,T.center[1],"S"));break;case"outline":"lon"===t?(a=a.concat(s(t,T.center[1]-89.99,"S")),a=a.concat(s(t,T.center[1]+89.99),"N")):(a=a.concat(s(t,T.center[0]-179.99,"E")),a=a.concat(s(t,T.center[0]+179.99,"W")));break;default:if(v(e[n])){a="lat"===t?a.concat(s(t,e[n],"N")):a.concat(s(t,e[n],"S"));break}}return c(a)}function c(t){for(var e=[],a=0;a<t.length;a++){var n={type:"Feature",id:a,properties:{},geometry:{type:"Point"}};n.properties.value=t[a].value,n.properties.orientation=t[a].orientation,n.geometry.coordinates=t[a].coordinates,e.push(n)}return e}function s(t,e,a){var n,r,o,i,l,c=t,s=[],u=e;"equatorial"===T.transform&&"lon"===c&&(c="ra"),"ra"===c?(n=T.lines.graticule.ra?T.lines.graticule.ra.min:0,r=T.lines.graticule.ra?T.lines.graticule.ra.max:23,o=T.lines.graticule.ra?T.lines.graticule.ra.step:1):"lon"===c?(n=T.lines.graticule.lon?T.lines.graticule.lon.min:0,r=T.lines.graticule.lon?T.lines.graticule.lon.max:350,o=T.lines.graticule.lon?T.lines.graticule.lon.step:10):(n=T.lines.graticule.lat?T.lines.graticule.lat.min:-80,r=T.lines.graticule.lat?T.lines.graticule.lat.max:80,o=T.lines.graticule.lat?T.lines.graticule.lat.step:10);for(var f=n;f<=r;f+=o){var d=a;"lat"===c?(l=[u,f],i=f.toString()+"°",0===f&&(i=""),d+=f<0?"S":"N"):"ra"===c?(l=[15*f,u],i=f.toString()+"ʰ"):(l=[f,u],i=f.toString()+"°"),s.push({coordinates:l,value:i,orientation:d})}return s}function u(t,a){for(var n=[],r=0;r<t.length;r++)n.push(e(t[r],a));return n}function f(t,e){for(var a=[],n=0;n<t.length;n++)a.push(u(t[n],e));return a}function d(t){return document.getElementById(t)}function h(t){return t+"px"}function p(t,e){return Math.round(Math.pow(10,e)*t)/Math.pow(10,e)}function g(t){return t<10?"0"+t:t}function m(t,e){return null!==t&&hasOwnProperty.call(t,e)}function v(t){return!isNaN(parseFloat(t))&&isFinite(t)}function y(t){return"[object Array]"===Object.prototype.toString.call(t)}function b(t,e){for(;t.parentNode;){if(t.id===e)return!0;t=t.parentNode}return!1}function M(t,e,a){var n=e.valueOf()-t.valueOf();switch(a||"d"){case"y":case"yr":n/=31556926080;break;case"m":case"mo":n/=26298e5;break;case"d":case"dy":n/=864e5;break;case"h":case"hr":n/=36e5;break;case"n":case"mn":n/=6e4;break;case"s":case"sec":n/=1e3}return Math.floor(n)}function w(t,e,a){return t=(t*W+V)%V,e=(e*W+V)%V,Math.abs(t-e)>Math.PI&&(t>e?t-=V:e>t&&(e-=V)),d3.interpolateNumber(t/W,e/W)}function k(t){var e=Math.round(t).toString(16);return 1==e.length&&(e="0"+e),e}function z(t){return"#"+k(t[0])+k(t[1])+k(t[2])}function I(t){return[parseInt(t[1]+t[2],16),parseInt(t[3]+t[4],16),parseInt(t[5]+t[6],16)]}function P(t,e){retColor=[0,0,0];for(var a=0;a<t.length;a++)retColor[0]+=t[a][0]*e[a],retColor[1]+=t[a][1]*e[a],retColor[2]+=t[a][2]*e[a];return retColor}function x(t){function e(){u.setTime(Date.now()),d("datetime").value=r(u,f),o()}function a(){navigator.geolocation.getCurrentPosition(function(t){s=[p(t.coords.latitude,4),p(t.coords.longitude,4)],d("lat").value=s[0],d("lon").value=s[1],o()})}function n(){h.show(u)}function r(t,e){var a;if(e&&"0"!==e){var n=Math.floor(Math.abs(e)/60),r=Math.abs(e)-60*n;a=(e<0?" +":" −")+g(n)+g(r)}else a=" ±0000";return l(t)+a}function o(){var e=d("lon").value,a=d("lat").value;console.log("go",d("datetime").value,d("datetime").value.slice(0,-6)),u=l.parse(d("datetime").value.slice(0,-6));var n=u.getTimezoneOffset(),r=new Date(u.valueOf()+6e4*(f-n));t.horizon.show=!!d("horizon-show").checked,t.planets.show=!!d("planets-show").checked,""!==e&&""!==a&&(s=[parseFloat(a),parseFloat(e)],c=q.getPoint(Y.inverse(r,[90,0],s),t.transform),c[2]=0,q.rotate({center:c,horizon:t.horizon}))}var i=d3.select("#celestial-form").append("div").attr("id","loc"),l=d3.time.format("%Y-%m-%d %H:%M:%S"),c=[0,0],s=[0,0],u=new Date,f=u.getTimezoneOffset(),h=new Q(function(t,e){d("datetime").value=r(t,e),f=e,o()});m(t,"geopos")&&null!==t.geopos&&2===t.geopos.length&&(s=t.geopos);var v=i.append("div").attr("class","col");v.append("label").attr("title","Location coordinates long/lat").attr("for","lat").html("Location"),v.append("input").attr("type","number").attr("id","lat").attr("title","Latitude").attr("placeholder","Latitude").attr("max","90").attr("min","-90").attr("step","0.0001").attr("value",s[0]).on("change",function(){!0===testNumber(this)&&o()}),v.append("span").html("°"),v.append("input").attr("type","number").attr("id","lon").attr("title","Longitude").attr("placeholder","Longitude").attr("max","180").attr("min","-180").attr("step","0.0001").attr("value",s[1]).on("change",function(){!0===testNumber(this)&&o()}),v.append("span").html("°"),"geolocation"in navigator&&v.append("input").attr("type","button").attr("value","Here").attr("id","here").on("click",a),v.append("label").attr("title","Local date/time").attr("for","datetime").html(" Date/time"),v.append("input").attr("type","button").attr("id","day-left").attr("title","One day back").on("click",function(){u.setDate(u.getDate()-1),d("datetime").value=r(u,f),o()}),v.append("input").attr("type","text").attr("id","datetime").attr("title","Date and time").attr("value",r(u,f)).on("click",n,!0).on("input",function(){this.value=r(u,f),h.isVisible()||n()}),v.append("div").attr("id","datepick").on("click",n),v.append("input").attr("type","button").attr("id","day-right").attr("title","One day forward").on("click",function(){u.setDate(u.getDate()+1),d("datetime").value=r(u,f),o()}),v.append("input").attr("type","button").attr("value","Now").attr("id","now").on("click",e),v.append("br"),v.append("label").attr("title","Show horizon marker").attr("for","horizon-show").html(" Horizon marker"),v.append("input").attr("type","checkbox").attr("id","horizon-show").property("checked",t.horizon.show).on("change",o),v.append("label").attr("title","Show solar system objects").attr("for","planets-show").html(" Planets, Sun & Moon"),v.append("input").attr("type","checkbox").attr("id","planets-show").property("checked",t.planets.show).on("change",o),d3.select(document).on("mousedown",function(){!b(d3.event.target,"celestial-date")&&h.isVisible()&&h.hide()}),q.date=function(t){if(!t)return u;u.setTime(t.valueOf()),d("datetime").value=r(t,f),q.redraw()},q.position=function(){return s},q.zenith=function(){return c},q.nadir=function(){var t=-c[1],e=c[0]+180;return e>180&&(e-=360),[e,t-.001]},setTimeout(o,1e3)}var T,A,j,C,S,D,E,q={version:"0.6.2",container:null,data:[]},F=3.035,N=1.4,O=2e3,_=2500,H=1500;q.display=function(a){function n(t,e){var a=t.getBoundingClientRect();return{x:e.clientX-a.left,y:e.clientY-a.top}}function r(){for(var t in T.lines)m(T.lines,t)&&("graticule"===t?(ct.append("path").datum(Dt).attr("class","graticule"),m(T.lines.graticule,"lon")&&T.lines.graticule.lon.pos.length>0&&ct.selectAll(".gridvalues_lon").data(l("lon",T.lines.graticule.lon.pos)).enter().append("path").attr("class","graticule_lon"),m(T.lines.graticule,"lat")&&T.lines.graticule.lat.pos.length>0&&ct.selectAll(".gridvalues_lat").data(l("lat",T.lines.graticule.lat.pos)).enter().append("path").attr("class","graticule_lat")):ct.append("path").datum(d3.geo.circle().angle([90]).origin(e(R[t],B[kt]))).attr("class",t));var t="telescopeRange";ct.append("path").datum(d3.geo.circle().angle([70]).origin(e(R[t],B[kt]))).attr("class",t),d3.json(At+"grid.geojson",function(t,e){if(t)return window.alert("Your Browser doesn't support local file loading or the file doesn't exist. See readme.md"),console.warn(t);var a=o(e,kt);ct.selectAll(".grid-polygons").data(a.features,function(t){return t.properties.id}).enter().append("path").attr("class",function(t){return"mw "+t.properties.id}).attr("count",function(t){return t.properties.count}),k("load"),ct.selectAll(".mw").each(function(t){for(var e=0;e<t.geometry.coordinates;e++)t.geometry.coordinates[e][0]>180&&(t.geometry.coordinates[e][0]=t.geometry.coordinates[e][0]-360)})}),ct.selectAll(".moon").data([T.moon]).enter().append("path").attr("class","moon"),q.data.length>0&&q.data.forEach(function(t){m(t,"file")?d3.json(t.file,t.callback):setTimeout(t.callback,0)},this)}function i(t){if(t&&1!==t){var e=A.scale(),a=e*t,n=C.scaleExtent(),r=H*Math.sqrt(Math.abs(1-t));a<n[0]&&(a=n[0]),a>n[1]&&(a=n[1]);var o=d3.interpolateNumber(e,a);return d3.select({}).transition().duration(r).tween("scale",function(){return function(t){var e=o(t);A.scale(e),k("zoom")}}).transition().duration(0).tween("scale",function(){C.scale(a),k("zoom")}),r}}function c(t){T=T.set(t),k("zoom")}function s(t){var e,a,n,r=T.center,o=A.rotate(),i=A.scale(),l=O,c=!1,s=T.orientationfixed;p(o[1],1)===-p(t.center[1],1)&&(c=!0),T=T.set(t);var u=p(d3.geo.distance(r,T.center),2),f=d3.geo.distance([r[2],0],[T.center[2],0]);return u<F&&f<F?(Tt=nt(T.center),A.rotate(Tt),k("rotate")):(a=i>Pt*N?d3.interpolateNumber(i,Pt):function(){return i},n=0===f?function(){return o[2]}:w(r[2],T.center[2]),u>3.14&&(T.center[0]-=.01),T.orientationfixed=!1,e=0===u?function(){return T.center}:d3.geo.interpolate(r,T.center),l=0!==u?l*u:l*f,d3.select({}).transition().duration(l).tween("center",function(){return function(t){var r=nt(e(t));r[2]=n(t);var i=a(t<.5?t:1-t);c&&(r[1]=o[1]),A.scale(i),A.rotate(r),k("rotate")}}).transition().duration(0).tween("center",function(){T.orientationfixed=s,Tt=nt(T.center),A.rotate(Tt),k("rotate")})),l}function u(t){gt=et(),(T.width!==gt||t)&&(It=gt/zt,Pt=mt.scale*gt/1024,Ct.attr("width",gt).attr("height",It),C.scaleExtent([Pt,5*Pt]).scale(Pt),A.translate([gt/2,It/2]).scale(Pt),dt&&(dt.style.height=h(It)),k("resize"))}function f(e){var a=at(e.projection);if(a){var n=A.rotate(),r=A.center(),o=A.scale(),l=C.scaleExtent(),c=q.projection(T.projection).center(r).translate([gt/2,It/2]).scale([l[0]]),s=_,u=0,d=d3.interpolateNumber(zt,a.ratio);mt.clip!=a.clip&&(s=0);var p=q.projection(e.projection).center(r).translate([gt/2,gt/a.ratio/2]).scale([a.scale*gt/1024]),g=T.adaptable,m=T.telescopeRange.show;return o>l[0]?(u=i(.1),setTimeout(f,u,e),u+s):(fldEnable("horizon-show",a.clip),A=t(c,p),T.adaptable=!1,T.telescopeRange.show=!1,d3.select({}).transition().duration(s).tween("projection",function(){return function(t){A.alpha(t).rotate(n),m8ap.projection(A),Z(a.clip),zt=d(t),It=gt/zt,Ct.attr("width",gt).attr("height",It),dt&&(dt.style.height=h(It)),k("projection")}}).transition().duration(0).tween("projection",function(){mt=a,zt=mt.ratio,It=gt/mt.ratio,Pt=mt.scale*gt/1024,Ct.attr("width",gt).attr("height",It),dt&&(dt.style.height=h(It)),T.projection=e.projection,A=q.projection(e.projection).rotate(n).translate([gt/2,It/2]).scale(Pt),S.projection(A),Z(mt.clip),C.projection(A).scaleExtent([Pt,5*Pt]).scale(Pt),T.adaptable=g,T.telescopeRange.show=m,j=q.projection(e.projection).translate([gt/2,It/2]).scale(Pt),D.projection(j),k("projection")}),s)}}function g(t){ct.selectAll(".mw").each(function(e){if(q.inside(yt,e.geometry.coordinates[0])&&bt!=e){var a=findFieldId(e,wt);bt=e,t(a,e)}})}function v(t){ct.selectAll(".mw").each(function(e){if(q.inside(yt,e.geometry.coordinates[0])){var a=findFieldId(e,wt);return bt=e,void t(a,e)}})}function y(){var t=0,e=0,a=(T.polygons.style,ct.selectAll(".mw"));a.each(function(a){for(var n=0,r=0;r<a.properties.count.length;++r){var o=a.properties.count[r][0];T.polygons.displayedFilters.indexOf(o)<0||(t+=a.properties.count[r][1],n+=a.properties.count[r][1])}n>e&&(e=n)}),a.each(function(t){St.beginPath();for(var a=0,n=0;n<t.properties.count.length;++n){var r=t.properties.count[n][0];T.polygons.displayedFilters.indexOf(r)<0||(a+=t.properties.count[n][1])}for(var o=[],i=[],n=0;n<t.properties.count.length;n++){var r=t.properties.count[n][0];if(!(T.polygons.displayedFilters.indexOf(r)<0))if(6!==T.polygons.displayedFilters.length){var l=T.polygons.filterColors[r];o.push(I(l)),i.push(t.properties.count[n][1]/a)}else o.push([200,200,200]),i.push(t.properties.count[n][1]/a)}var c=z(P(o,i));St.fillStyle=T.background.fill,"#000000"!==c&&(St.fillStyle=c,St.globalAlpha=Math.min(1,Math.pow(a/e,.5))),S(t),St.fill()})}function b(){ct.selectAll(".moon").each(function(t){var e=T.moon.size*gt/960,a=A(t.pos);$(T.moon.style),St.beginPath(),St.arc(a[0],a[1],e,0,2*Math.PI),St.closePath(),St.fill()})}function M(){var t=A.rotate();T.adaptable&&(xt=Math.sqrt(A.scale()/Pt)),xt||(xt=1),T.orientationfixed&&(t[2]=T.center[2],A.rotate(t)),T.center=[-t[0],-t[1],t[2]],tt(),V(),T.polygons.show&&y(),T.moon&&T.moon.show&&b();for(var e in T.lines)m(T.lines,e)&&!0===T.lines[e].show&&($(T.lines[e]),ct.selectAll("."+e).attr("d",S),St.stroke());var e="telescopeRange";T[e].show&&($(T[e]),ct.selectAll("."+e).attr("d",function(t){return D(t)}),St.stroke()),m(T.lines.graticule,"lon")&&(Q(T.lines.graticule.lon),ct.selectAll(".graticule_lon").each(function(t,e){if(W(t.geometry.coordinates)){var a=A(t.geometry.coordinates);K(a,t.properties.orientation),St.fillText(t.properties.value,a[0],a[1])}})),m(T.lines.graticule,"lat")&&(Q(T.lines.graticule.lat),ct.selectAll(".graticule_lat").each(function(t,e){if(W(t.geometry.coordinates)){var a=A(t.geometry.coordinates);K(a,t.properties.orientation),St.fillText(t.properties.value,a[0],a[1])}})),V(!0),q.data.length>0&&q.data.forEach(function(t){t.redraw("Celestial.data")}),T.location&&T.horizon.show&&!mt.clip&&(E.origin(q.nadir()),$(T.horizon),ct.selectAll(".horizon").datum(E).attr("d",S),St.fill(),T.horizon.stroke&&St.stroke()),T.controls&&X(A.scale())}function k(t){M()}function V(t){var e=A.rotate();A.rotate([0,0]),$(T.background),ct.selectAll(".outline").attr("d",S),t?St.stroke():St.fill(),A.rotate(e)}function W(t){return mt.clip&&d3.geo.distance(T.center,t)>G?0:1}function $(t){St.fillStyle=t.fill||null,St.strokeStyle=t.stroke||null,St.lineWidth=t.width||null,St.globalAlpha=t.opacity||1,St.font=t.font||null,m(t,"dash")?St.setLineDash(t.dash):St.setLineDash([]),St.beginPath()}function Q(t){St.fillStyle=t.fill,St.textAlign=t.align||"left",St.textBaseline=t.baseline||"bottom",St.globalAlpha=t.opacity||1,St.font=t.font}function X(t){var e=d("celestial-zoomin"),a=d("celestial-zoomout");e&&a&&(e.disabled=t>=4.99*Pt,a.disabled=t<=Pt)}function Z(t){t?(A.clipAngle(90),ct.selectAll(".outline").remove(),ct.append("path").datum(d3.geo.circle().angle([90])).attr("class","outline")):(A.clipAngle(null),ct.selectAll(".outline").remove(),ct.append("path").datum(Dt.outline).attr("class","outline"))}function K(t,e){for(var a=e.split(""),n="center",r="middle",o=a.length-1;o>=0;o--)switch(a[o]){case"N":r="bottom";break;case"S":r="top";break;case"E":n="left",t[0]+=2;break;case"W":n="right",t[0]-=2}return St.textAlign=n,St.textBaseline=r,t}function tt(){St.clearRect(0,0,gt+pt[0],It+pt[1])}function et(){return T.width&&T.width>0?T.width:dt?dt.clientWidth-pt[0]:window.innerWidth-2*pt[0]}function at(t){if(m(J,t)){var e=J[t];return m(e,"ratio")||(e.ratio=2),e}}function nt(t){if(null===t)return[0,0,0];var e=L.equatorial;return t[2]||(t[2]=0),[e[0]-t[0],e[1]-t[1],e[2]+t[2]]}function rt(){if(st&&!(st.length<1)){var t,e=st[ut];switch(e.param){case"projection":t=f({projection:e.value});break;case"center":t=s({center:e.value});break;case"zoom":t=i(e.value)}e.callback&&setTimeout(e.callback,t),ut++,!0===ft&&ut===st.length&&(ut=0),t=0===e.duration||e.duration<t?t:e.duration,ut<st.length&&(lt=setTimeout(rt,t))}}function ot(){clearTimeout(lt)}var it,lt,ct=q.container,st=[],ut=0,ft=!1;T=U.set(a),T.center=T.center||[0,0],T.lang&&-1!==T.lang.search(/^de|es$/)||(T.lang="name");var dt=d(T.container);if(dt){it="#"+T.container;var ht=window.getComputedStyle(dt,null);parseInt(ht.width)||T.width||(dt.style.width=h(dt.parentNode.clientWidth))}else it="body",dt=null;var pt=[16,16],gt=et(),mt=at(T.projection),vt=!1,yt=null,bt=null,Mt={},wt=null;if(T.lines.graticule.lat&&"outline"===T.lines.graticule.lat.pos[0]&&(mt.scale-=2),mt){var kt=T.transform||"equatorial",zt=mt.ratio,It=gt/zt,Pt=mt.scale*gt/1024,xt=1,Tt=nt(T.center),At=T.datapath||"";At=At.replace(/([^\/]$)/,"$1/"),"body"!=it&&(d(T.container).style.height=h(It)),A=q.projection(T.projection).rotate(Tt).translate([gt/2,It/2]).scale(Pt),j=q.projection(T.projection).rotate(Tt).translate([gt/2,It/2]).scale(Pt);var jt=function(){k("zoom")};C=d3.geo.zoom().projection(A).center([gt/2,It/2]).scaleExtent([Pt,5*Pt]).on("zoom.redraw",jt);var Ct=d3.selectAll("#"+T.container+"canvas");0===Ct[0].length&&(Ct=d3.select(it).append("canvas")),Ct.attr("width",gt).attr("height",It);var St=Ct.node().getContext("2d"),Dt=d3.geo.graticule().minorStep([45,30]);S=d3.geo.path().projection(A).context(St),D=d3.geo.path().projection(j).context(St),Ct[0][0].addEventListener("mousemove",function(t){var e=n(Ct[0][0],t);yt=A.invert([e.x,e.y]),T.cellHoverCallback&&g(T.cellHoverCallback)},!1),Ct[0][0].addEventListener("mousedown",function(t){vt=!0,T.cellClickCallback&&v(T.cellClickCallback)}),Ct[0][0].addEventListener("mouseup",function(t){vt=!1}),ct?ct.selectAll("*").remove():ct=d3.select(it).append("container"),T.interactive?Ct.call(C):Ct.attr("style","cursor: default!important"),Z(mt.clip),d3.select(window).on("resize",u),!0===T.controls&&null===d("celestial-zoomin")&&(d3.select(it).append("input").attr("type","button").attr("id","celestial-zoomin").attr("value","+").on("click",function(){i(1.111)}),d3.select(it).append("input").attr("type","button").attr("id","celestial-zoomout").attr("value","−").on("click",function(){i(.9)})),!0===T.location&&(E=d3.geo.circle().angle([90]),ct.append("path").datum(E).attr("class","horizon"),null===d("loc")?x(T):s({center:q.zenith()}),fldEnable("horizon-show",mt.clip)),!0===T.form&&null===d("params")&&form(T),null===d("error")&&d3.select("body").append("div").attr("id","error"),q.updateCell=function(t,e){e?d3.selectAll(".t"+t).each(function(t){t.properties.count=e}):d3.selectAll(".t"+t).each(function(t){t.properties.count=parseInt(t.properties.count)+10+""})},q.updateCellsOld=function(t){var e=ct.selectAll(".mw");e.each(function(t){for(var e=0;e<t.properties.count.length;++e)t.properties.count[e][1]=0});for(var a=0;a<t.length;++a){var n=t[a],r=(n.fieldID,n.fieldRA);r>180?r-=360:r=r;var o=n.fieldDec,i=n.filterName,l=n.count;e.each(function(t){if(q.inside([r,o],t.geometry.coordinates[0])){for(var e=!1,a=0;a<t.properties.count.length;++a)t.properties.count[a][0]==i&&(t.properties.count[a][1]=l,e=!0);e||t.properties.count.push([i,l])}})}},findFieldId=function(t,e){for(var a=Object.keys(Mt),n=t.properties.id,r=0;r<a.length;++r){var o=a[r];if(Mt[o]==n)return o}return null},findPolygonId=function(t,e){var a=null,n=e.fieldID;if(Mt[n])a=Mt[n];else{var r=(e.fieldID,e.fieldRA);r>180?r-=360:r=r;var o=e.fieldDec;e.filterName,e.count;t.each(function(t){q.inside([r,o],t.geometry.coordinates[0])&&(a=t.properties.id,Mt[n]=a)})}return a},q.updateCells=function(t){wt=t;var e=ct.selectAll(".mw");e.each(function(t){for(var e=0;e<t.properties.count.length;++e)t.properties.count[e][1]=0});for(var a=0;a<t.length;++a){var n=t[a],r=(n.fieldID,n.fieldRA);r>180?r-=360:r=r;var o=(n.fieldDec,n.filterName),i=n.count,l=findPolygonId(e,n);e.each(function(t){if(l==t.properties.id){for(var e=!1,a=0;a<t.properties.count.length;++a)t.properties.count[a][0]==o&&(t.properties.count[a][1]=i,e=!0);e||t.properties.count.push([o,i])}})}},q.inside=function(t,e){if(!t)return!1;for(var a=t[0],n=t[1],r=!1,o=0,i=e.length-1;o<e.length;i=o++){var l=e[o][0],c=e[o][1],s=e[i][0],u=e[i][1];c>n!=u>n&&a<(s-l)*(n-c)/(u-c)+l&&(r=!r)}return r},q.goToDate=function(t){var e=t.getTimezoneOffset(),a=t.getTimezoneOffset(),n=new Date(t.valueOf()+6e4*(e-a));geopos=[parseFloat(0),parseFloat(-70)],zenith=q.getPoint(Y.inverse(n,[90,0],geopos),T.transform),zenith[2]=0,q.rotate({center:zenith,horizon:T.horizon})},this.container=ct,this.clip=W,this.map=S,this.mapProjection=A,this.context=St,this.setStyle=$,this.setTextStyle=Q,this.redraw=k,this.resize=function(t){t&&m(t,"width")&&(T.width=t.width),u(!0)},this.reload=function(t){t&&m(t,"transform")&&(kt=T.transform=t.transform,Dt.minorStep([45,30]),ct.selectAll("*").remove(),Z(),ct.append("path").datum(E).attr("class","horizon"),r())},this.apply=function(t){c(t)},this.reproject=function(t){return f(t)},this.rotate=function(t){return t?s(t):T.center},this.zoomBy=function(t){return t?i(t):A.scale()/Pt},this.color=function(t){return"#000"},this.animate=function(t,e){t&&(st=t,ut=0,ft=!!e,rt())},this.stop=function(t){ot(),!0===t&&(st=[])},this.go=function(t){st.length<1||(t&&t<st.length&&(ut=t),rt())},r()}},q.projection=function(t){var e,a,n;if(!m(J,t))throw new Error("Projection not supported: "+t);return e=J[t],a=null!==e.arg?d3.geo[t].raw(e.arg):d3.geo[t].raw,n=function(t,e){return a(-t,e)},n.invert=function(t,e){var n=a.invert(t,e);return n?(n[0]*=-1,n):null},d3.geo.projection(n)};var L={equatorial:[0,0,0],ecliptic:[0,0,23.4393],galactic:[93.5949,28.9362,-58.5988],telescopeRange:[0,0,0],supergalactic:[137.31,59.5283,57.7303]},R={equatorial:[0,90],ecliptic:[-90,66.5607],galactic:[-167.1405,27.1283],telescopeRange:[0,-30.240722],supergalactic:[-76.2458,15.7089]};q.eulerAngles=function(){return L},q.poles=function(){return R};var V=2*Math.PI,G=Math.PI/2,W=Math.PI/180,B={ecliptic:[-90,23.4393,90],"inverse ecliptic":[90,23.4393,-90],galactic:[-167.1405,62.8717,122.9319],telescopeRange:[-90,23.4393,90],"inverse galactic":[122.9319,62.8717,-167.1405],supergalactic:[283.7542,74.2911,26.4504],"inverse supergalactic":[26.4504,74.2911,283.7542],init:function(){for(var t in this)this[t].constructor==Array&&(this[t]=this[t].map(function(t){return t*W}))},add:function(t,e){if(e&&t&&3===e.length&&!this.hasOwnProperty(t))return this[t]=e.map(function(t){return t*W}),this[t]}};B.init(),q.euler=function(){return B};var Y=function(t,e,a){var r=n(t,a[1])-e[0];r<0&&(r+=360),r*=W;var o=e[1]*W,i=a[0]*W,l=Math.asin(Math.sin(o)*Math.sin(i)+Math.cos(o)*Math.cos(i)*Math.cos(r)),c=Math.acos((Math.sin(o)-Math.sin(l)*Math.sin(i))/(Math.cos(l)*Math.cos(i)));return Math.sin(r)>0&&(c=2*Math.PI-c),[l/W,c/W,0]};Y.inverse=function(t,e,a){var r=e[0]*W,o=e[1]*W,i=a[0]*W,l=Math.asin(Math.sin(r)*Math.sin(i)+Math.cos(r)*Math.cos(i)*Math.cos(o)),c=((Math.sin(r)-Math.sin(l)*Math.sin(i))/(Math.cos(l)*Math.cos(i))).toFixed(6);return c=Math.acos(c),c/=W,[n(t,a[1])-c,l/W,0]},q.horizontal=Y,q.add=function(t){var e={};return m(t,"type")?"dso"!==t.type||m(t,"file")&&m(t,"callback")?"line"!==t.type||m(t,"callback")?(m(t,"file")&&(e.file=t.file),e.type=t.type,m(t,"callback")&&(e.callback=t.callback),m(t,"redraw")&&(e.redraw=t.redraw),void q.data.push(e)):console.log("Can't add line"):console.log("Can't add data file"):console.log("Missing type")},q.getData=o,q.getPoint=r;var U={width:0,projection:"aitoff",transform:"equatorial",center:null,geopos:null,orientationfixed:!0,adaptable:!0,interactive:!0,form:!1,location:!1,fullwidth:!1,controls:!0,lang:"",cellHoverCallback:null,cellClickCallback:null,container:"celestial-map",datapath:"data/",polygons:{show:!0,style:{fill:"#ffffff",opacity:"0.15"},filterColors:{u:"#0000ff",g:"#008000",r:"#ffff00",i:"#ff0000",z:"#ee82ee",y:"#ffffff"},displayedFilters:["u","g","r","i","z","y"]},moon:{show:!0,pos:[30,315],size:15,style:{fill:"#ffffff",opacity:"1"}},lines:{graticule:{show:!0,stroke:"#cccccc",width:.6,opacity:.8,lon:{pos:[""],fill:"#eee",font:"0.8em Helvetica, Arial, sans-serif",min:0,max:350,step:10},lat:{pos:[""],fill:"#eee",font:"0.8em Helvetica, Arial, sans-serif",min:-80,max:80,step:10},ra:{min:0,max:23,step:1}},equatorial:{show:!0,stroke:"#aaaaaa",width:1.3,opacity:.7},ecliptic:{show:!1,stroke:"#66cc66",width:1.3,opacity:.7},galactic:{show:!1,stroke:"#cc6666",width:1.3,opacity:.7},supergalactic:{show:!1,stroke:"#cc66cc",width:1.3,opacity:.7}},telescopeRange:{show:!0,stroke:"#cc0000",width:1.3,opacity:.7,dash:[]},background:{fill:"#000000",opacity:1,stroke:"#000000",width:1.5},horizon:{show:!1,stroke:"#000099",width:1,fill:"#000000",opacity:.5},planets:{show:!1,which:["sol","mer","ven","ter","lun","mar","jup","sat","ura","nep"],style:{fill:"#00ccff",font:"bold 17px 'Lucida Sans Unicode', Consolas, sans-serif",align:"center",baseline:"middle"},symbols:{sol:{symbol:"☉",fill:"#ffff00"},mer:{symbol:"☿",fill:"#cccccc"},ven:{symbol:"♀",fill:"#eeeecc"},ter:{symbol:"⊕",fill:"#00ffff"},lun:{symbol:"●",fill:"#ffffff"},mar:{symbol:"♂",fill:"#ff9999"},cer:{symbol:"⚳",fill:"#cccccc"},ves:{symbol:"⚶",fill:"#cccccc"},jup:{symbol:"♃",fill:"#ff9966"},sat:{symbol:"♄",fill:"#ffcc66"},ura:{symbol:"♅",fill:"#66ccff"},nep:{symbol:"♆",fill:"#6666ff"},plu:{symbol:"♇",fill:"#aaaaaa"},eri:{symbol:"⚪",fill:"#eeeeee"}}},daylight:{show:!1,fill:"#fff",opacity:.4},set:function(t){var e,a,n={};if(!t)return this;for(e in this)if(m(this,e))if(m(t,e)&&null!==t[e])if(null===this[e]||this[e].constructor!=Object)n[e]=t[e];else{n[e]={};for(a in this[e])m(t[e],a)?n[e][a]=t[e][a]:n[e][a]=this[e][a]}else n[e]=this[e];return n}};q.settings=function(){return U};var J=(d3.scale.quantize().domain([3.347,-.335]).range(["#ff4700","#ff4b00","#ff4f00","#ff5300","#ff5600","#ff5900","#ff5b00","#ff5d00","#ff6000","#ff6300","#ff6500","#ff6700","#ff6900","#ff6b00","#ff6d00","#ff7000","#ff7300","#ff7500","#ff7800","#ff7a00","#ff7c00","#ff7e00","#ff8100","#ff8300","#ff8506","#ff870a","#ff8912","#ff8b1a","#ff8e21","#ff9127","#ff932c","#ff9631","#ff9836","#ff9a3c","#ff9d3f","#ffa148","#ffa34b","#ffa54f","#ffa753","#ffa957","#ffab5a","#ffad5e","#ffb165","#ffb269","#ffb46b","#ffb872","#ffb975","#ffbb78","#ffbe7e","#ffc184","#ffc489","#ffc78f","#ffc892","#ffc994","#ffcc99","#ffce9f","#ffd1a3","#ffd3a8","#ffd5ad","#ffd7b1","#ffd9b6","#ffdbba","#ffddbe","#ffdfc2","#ffe1c6","#ffe3ca","#ffe4ce","#ffe8d5","#ffe9d9","#ffebdc","#ffece0","#ffefe6","#fff0e9","#fff2ec","#fff4f2","#fff5f5","#fff6f8","#fff9fd","#fef9ff","#f9f6ff","#f6f4ff","#f3f2ff","#eff0ff","#ebeeff","#e9edff","#e6ebff","#e3e9ff","#e0e7ff","#dee6ff","#dce5ff","#d9e3ff","#d7e2ff","#d3e0ff","#c9d9ff","#bfd3ff","#b7ceff","#afc9ff","#a9c5ff","#a4c2ff","#9fbfff","#9bbcff"]),{airy:{n:"Airy’s Minimum Error",arg:Math.PI/2,scale:360,ratio:1,clip:!0},aitoff:{n:"Aitoff",arg:null,scale:162},armadillo:{n:"Armadillo",arg:0,scale:250},august:{n:"August",arg:null,scale:94,ratio:1.4},azimuthalEqualArea:{n:"Azimuthal Equal Area",arg:null,scale:340,ratio:1,clip:!0},azimuthalEquidistant:{n:"Azimuthal Equidistant",arg:null,scale:320,ratio:1,clip:!0},baker:{n:"Baker Dinomic",arg:null,scale:160,ratio:1.4},berghaus:{n:"Berghaus Star",arg:0,scale:320,ratio:1,clip:!0},boggs:{n:"Boggs Eumorphic",arg:null,scale:170},bonne:{n:"Bonne",arg:Math.PI/5,scale:225,ratio:.88},bromley:{n:"Bromley",arg:null,scale:162},collignon:{n:"Collignon",arg:null,scale:100,ratio:2.6},craig:{n:"Craig Retroazimuthal",arg:0,scale:310,ratio:1.5,clip:!0},craster:{n:"Craster Parabolic",arg:null,scale:160},cylindricalEqualArea:{n:"Cylindrical Equal Area",arg:Math.PI/6,scale:190,ratio:2.3},cylindricalStereographic:{n:"Cylindrical Stereographic",arg:Math.PI/4,scale:230,ratio:1.3},eckert1:{n:"Eckert I",arg:null,scale:175},eckert2:{n:"Eckert II",arg:null,scale:175},eckert3:{n:"Eckert III",arg:null,scale:190},eckert4:{n:"Eckert IV",arg:null,scale:190},eckert5:{n:"Eckert V",arg:null,scale:182},eckert6:{n:"Eckert VI",arg:null,scale:182},eisenlohr:{n:"Eisenlohr",arg:null,scale:102},equirectangular:{n:"Equirectangular",arg:null,scale:165},fahey:{n:"Fahey",arg:null,scale:196,ratio:1.4},mtFlatPolarParabolic:{n:"Flat Polar Parabolic",arg:null,scale:175},mtFlatPolarQuartic:{n:"Flat Polar Quartic",arg:null,scale:230,ratio:1.65},mtFlatPolarSinusoidal:{n:"Flat Polar Sinusoidal",arg:null,scale:175,ratio:1.9},foucaut:{n:"Foucaut",arg:null,scale:142},ginzburg4:{n:"Ginzburg IV",arg:null,scale:180,ratio:1.7},ginzburg5:{n:"Ginzburg V",arg:null,scale:196,ratio:1.55},ginzburg6:{n:"Ginzburg VI",arg:null,scale:190,ratio:1.4},ginzburg8:{n:"Ginzburg VIII",arg:null,scale:205,ratio:1.3},ginzburg9:{n:"Ginzburg IX",arg:null,scale:190,ratio:1.4},homolosine:{n:"Goode Homolosine",arg:null,scale:160,ratio:2.2},hammer:{n:"Hammer",arg:2,scale:180},hatano:{n:"Hatano",arg:null,scale:186},healpix:{n:"HEALPix",arg:1,scale:320,ratio:1.2},hill:{n:"Hill Eucyclic",arg:2,scale:190,ratio:1.1},kavrayskiy7:{n:"Kavrayskiy VII",arg:null,scale:185,ratio:1.75},lagrange:{n:"Lagrange",arg:Math.PI/4,scale:88,ratio:1.6,clip:!1},larrivee:{n:"l'Arrivée",arg:null,scale:160,ratio:1.25},laskowski:{n:"Laskowski Tri-Optimal",arg:null,scale:165,ratio:1.7},loximuthal:{n:"Loximuthal",arg:Math.PI/4,scale:175,ratio:1.8},mercator:{n:"Mercator",arg:null,scale:160,ratio:1.3},miller:{n:"Miller",arg:null,scale:160,ratio:1.5},mollweide:{n:"Mollweide",arg:null,scale:180},naturalEarth:{n:"Natural Earth",arg:null,scale:185,ratio:1.85},nellHammer:{n:"Nell Hammer",arg:null,scale:160,ratio:2.6},orthographic:{n:"Orthographic",arg:null,scale:480,ratio:1,clip:!0},patterson:{n:"Patterson Cylindrical",arg:null,scale:160,ratio:1.75},polyconic:{n:"Polyconic",arg:null,scale:160,ratio:1.3},rectangularPolyconic:{n:"Rectangular Polyconic",arg:0,scale:160,ratio:1.65},robinson:{n:"Robinson",arg:null,scale:160},sinusoidal:{n:"Sinusoidal",arg:null,scale:160,ratio:2},stereographic:{n:"Stereographic",arg:null,scale:500,ratio:1,clip:!0},times:{n:"Times",arg:null,scale:210,ratio:1.4},twoPointEquidistant:{n:"Two-Point Equidistant",arg:Math.PI/2,scale:320,ratio:1.15,clip:!0},vanDerGrinten:{n:"van Der Grinten",arg:null,scale:160,ratio:1},vanDerGrinten2:{n:"van Der Grinten II",arg:null,scale:160,ratio:1},vanDerGrinten3:{n:"van Der Grinten III",arg:null,scale:160,ratio:1},vanDerGrinten4:{n:"van Der Grinten IV",arg:null,scale:160,ratio:1.6},wagner4:{n:"Wagner IV",arg:null,scale:185},wagner6:{n:"Wagner VI",arg:null,scale:160},wagner7:{n:"Wagner VII",arg:null,scale:190,ratio:1.8},wiechel:{n:"Wiechel",arg:null,scale:360,ratio:1,clip:!0},winkel3:{n:"Winkel Tripel",arg:null,scale:196,ratio:1.7}});q.projections=function(){return J};var $={};$.symbol=function(){function t(t){i[a()](t)}var e,a=d3.functor("circle"),n=d3.functor(64),r=d3.functor(Math.PI),o=(d3.functor("#fff"),d3.functor("")),i=(d3.functor([2,2]),{circle:function(t){
var a=Math.sqrt(n()),r=a/2;return t.arc(e[0],e[1],r,0,2*Math.PI),r},square:function(t){var a=Math.sqrt(n()),r=a/1.7;return t.moveTo(e[0]-r,e[1]-r),t.lineTo(e[0]+r,e[1]-r),t.lineTo(e[0]+r,e[1]+r),t.lineTo(e[0]-r,e[1]+r),t.closePath(),r},diamond:function(t){var a=Math.sqrt(n()),r=a/1.5;return t.moveTo(e[0],e[1]-r),t.lineTo(e[0]+r,e[1]),t.lineTo(e[0],e[1]+r),t.lineTo(e[0]-r,e[1]),t.closePath(),r},triangle:function(t){var a=Math.sqrt(n()),r=a/Math.sqrt(3);return t.moveTo(e[0],e[1]-r),t.lineTo(e[0]+r,e[1]+r),t.lineTo(e[0]-r,e[1]+r),t.closePath(),r},ellipse:function(t){var a=Math.sqrt(n()),r=a/2;return t.save(),t.translate(e[0],e[1]),t.scale(1.6,.8),t.beginPath(),t.arc(0,0,r,0,2*Math.PI),t.closePath(),t.restore(),r},marker:function(t){var a=Math.sqrt(n()),r=a/2;return t.moveTo(e[0],e[1]-r),t.lineTo(e[0],e[1]+r),t.moveTo(e[0]-r,e[1]),t.lineTo(e[0]+r,e[1]),t.closePath(),r},"cross-circle":function(t){var a=Math.sqrt(n()),r=a/2;return t.moveTo(e[0],e[1]-a),t.lineTo(e[0],e[1]+a),t.moveTo(e[0]-a,e[1]),t.lineTo(e[0]+a,e[1]),t.stroke(),t.beginPath(),t.moveTo(e[0],e[1]),t.arc(e[0],e[1],r,0,2*Math.PI),t.closePath(),r},"stroke-circle":function(t){var a=Math.sqrt(n()),r=a/2;return t.moveTo(e[0],e[1]-a),t.lineTo(e[0],e[1]+a),t.stroke(),t.beginPath(),t.moveTo(e[0],e[1]),t.arc(e[0],e[1],r,0,2*Math.PI),t.closePath(),r},crescent:function(t){var a=Math.sqrt(n()),o=a/2,i=r(),l=.5*(1-Math.cos(i)),c=1.6*Math.abs(l-.5)+.01,s=i>Math.PI,u=Math.abs(l)>.5?s:!s;return t.save(),t.fillStyle="#557",t.moveTo(e[0],e[1]),t.arc(e[0],e[1],o,0,2*Math.PI),t.closePath(),t.fill(),t.fillStyle="#eee",t.beginPath(),t.moveTo(e[0],e[1]),t.arc(e[0],e[1],o,-Math.PI/2,Math.PI/2,s),t.scale(c,1),t.arc(e[0]/c,e[1],o,Math.PI/2,-Math.PI/2,u),t.closePath(),t.fill(),t.restore(),o}});return t.type=function(e){return arguments.length?(a=d3.functor(e),t):a},t.size=function(e){return arguments.length?(n=d3.functor(e),t):n},t.age=function(e){return arguments.length?(r=d3.functor(e),t):r},t.text=function(e){return arguments.length?(o=d3.functor(e),t):o},t.position=function(a){if(arguments.length)return e=a,t},t},q.Canvas=$;var Q=function(t){function e(){var t=d("mon").value,e=d("yr").value,a=new Date(e,t,1),n=d3.select("#cal"),r=new Date;e=parseInt(e),t=parseInt(t),a.setDate(a.getDate()-a.getDay());for(var o=n.node();o.firstChild;)o.removeChild(o.firstChild);for(var c=0;c<42;c++){var s=a.getMonth(),u=a.getDay(),h=f(a);n.append("div").classed({date:!0,grey:s!==t,weekend:s===t&&(0===u||6===u),today:0===M(a,r),selected:0===M(a,l)}).attr("id",h).on("click",i).html(a.getDate().toString()),a.setDate(a.getDate()+1)}}function a(t){p.append("div").attr("id",t).on("click",function(){var a=d("mon"),n=d("yr");"left"===t?0===a.selectedIndex?(a.selectedIndex=11,n.selectedIndex--):a.selectedIndex--:11===a.selectedIndex?(a.selectedIndex=0,n.selectedIndex++):a.selectedIndex++,e()})}function n(t,e){for(var a=d(t),n=0;n<a.childNodes.length;n++)if(a.childNodes[n].value==e){a.selectedIndex=n;break}}function r(t){t&&l.setTime(t.valueOf()),n("yr",l.getFullYear()),n("mon",l.getMonth()),e(),d("hr").value=l.getHours(),d("min").value=l.getMinutes(),d("sec").value=l.getSeconds()}function o(){d3.select("#celestial-date").style("opacity",0),d3.select("#error").style({top:"-9999px",left:"-9999px",opacity:0}),d3.select("#datepick").classed("active",!1),setTimeout(function(){d("celestial-date").style.top=h(-9999)},600)}function i(){var e=d("hr").value,a=d("min").value,n=d("sec").value,o=d("tz").value;this.id&&-1!==this.id.search(/^\d/)&&(l=f.parse(this.id)),l.setHours(e,a,n),r(),t(l,o)}var l=new Date,c=(d3.time.format("%Z"),[{"−12:00":720},{"−11:00":660},{"−10:00":600},{"−09:30":570},{"−09:00":540},{"−08:00":480},{"−07:00":420},{"−06:00":360},{"−05:00":300},{"−04:30":270},{"−04:00":240},{"−03:30":210},{"−03:00":180},{"−02:00":120},{"−01:00":60},{"±00:00":0},{"+01:00":-60},{"+02:00":-120},{"+03:00":-180},{"+03:30":-210},{"+04:00":-240},{"+04:30":-270},{"+05:00":-300},{"+05:30":-330},{"+05:45":-345},{"+06:00":-360},{"+06:30":-390},{"+07:00":-420},{"+08:00":-480},{"+08:30":-510},{"+08:45":-525},{"+09:00":-540},{"+09:30":-570},{"+10:00":-600},{"+10:30":-630},{"+11:00":-660},{"+12:00":-720},{"+12:45":-765},{"+13:00":-780},{"+14:00":-840}]),s=["January","February","March","April","May","June","July","August","September","October","November","December"],u=function(t){for(var e=t.getFullYear(),a=[],n=e-10;n<=e+10;n++)a.push(n);return a}(l),f=d3.time.format("%Y-%m-%d"),p=d3.select("#celestial-form").append("div").attr("id","celestial-date");a("left"),function(){var t=p.append("select").attr("title","Month").attr("id","mon").on("change",e),a=0,n=l.getMonth();t.selectAll("option").data(s).enter().append("option").attr("value",function(t,e){return e===n&&(a=e),e}).text(function(t){return t}),t.property("selectedIndex",a)}(),function(){var t=p.append("select").attr("title","Year").attr("id","yr").on("change",e),a=0,n=l.getFullYear();t.selectAll("option").data(u).enter().append("option").text(function(t,e){return t===n&&(a=e),t.toString()}),t.property("selectedIndex",a)}(),a("right");p.append("div").attr("id","cal");e(),function(){p.append("input").attr("type","number").attr("id","hr").attr("title","Hours").attr("max","24").attr("min","-1").attr("step","1").attr("value",l.getHours()).on("change",function(){!0===testNumber(this)&&i()}),p.append("input").attr("type","number").attr("id","min").attr("title","Minutes").attr("max","60").attr("min","-1").attr("step","1").attr("value",l.getMinutes()).on("change",function(){!0===testNumber(this)&&i()}),p.append("input").attr("type","number").attr("id","sec").attr("title","Seconds").attr("max","60").attr("min","-1").attr("step","1").attr("value",l.getSeconds()).on("change",function(){!0===testNumber(this)&&i()})}(),function(){var t=p.append("select").attr("title","Time zone offset from UTC").attr("id","tz").on("change",i),e=15,a=l.getTimezoneOffset();t.selectAll("option").data(c).enter().append("option").attr("value",function(t,n){var r=Object.keys(t)[0];return t[r]===a&&(e=n),t[r]}).text(function(t){return Object.keys(t)[0]}),t.property("selectedIndex",e)}(),this.show=function(t){var e=d("celestial-date"),a=d("datepick"),n=a.offsetLeft+a.offsetWidth-e.offsetWidth,i=a.offsetTop-e.offsetHeight-1;-9999===e.offsetTop?(l.setTime(t.valueOf()),r(),d3.select("#celestial-date").style({top:h(i),left:h(n),opacity:1}),d3.select("#datepick").classed("active",!0)):o()},this.isVisible=function(){return-9999!==d("celestial-date").offsetTop},this.hide=function(){o()}};return function(){function t(t,e,a){var n=t.translate(),r=Math.atan2(e[1]-n[1],e[0]-n[0])-Math.atan2(a[1]-n[1],a[0]-n[0]);return[Math.cos(r/2),0,0,Math.sin(r/2)]}function e(t,e){var a=t.invert(e);return a&&isFinite(a[0])&&isFinite(a[1])&&l(a)}function a(t){var e=.5*t[0]*f,a=.5*t[1]*f,n=.5*t[2]*f,r=Math.sin(e),o=Math.cos(e),i=Math.sin(a),l=Math.cos(a),c=Math.sin(n),s=Math.cos(n);return[o*l*s+r*i*c,r*l*s-o*i*c,o*i*s+r*l*c,o*l*c-r*i*s]}function n(t,e){var a=t[0],n=t[1],r=t[2],o=t[3],i=e[0],l=e[1],c=e[2],s=e[3];return[a*i-n*l-r*c-o*s,a*l+n*i+r*s-o*c,a*c-n*s+r*i+o*l,a*s+n*c-r*l+o*i]}function r(t,e){if(t&&e){var a=s(t,e),n=Math.sqrt(c(a,a)),r=.5*Math.acos(Math.max(-1,Math.min(1,c(t,e)))),o=Math.sin(r)/n;return n&&[Math.cos(r),a[2]*o,-a[1]*o,a[0]*o]}}function o(t,e){var a=Math.max(-1,Math.min(1,c(t,e))),n=a<0?-1:1,r=Math.acos(n*a),o=Math.sin(r);return o?function(a){var i=n*Math.sin((1-a)*r)/o,l=Math.sin(a*r)/o;return[t[0]*i+e[0]*l,t[1]*i+e[1]*l,t[2]*i+e[2]*l,t[3]*i+e[3]*l]}:function(){return t}}function i(t){return[Math.atan2(2*(t[0]*t[1]+t[2]*t[3]),1-2*(t[1]*t[1]+t[2]*t[2]))*d,Math.asin(Math.max(-1,Math.min(1,2*(t[0]*t[2]-t[3]*t[1]))))*d,Math.atan2(2*(t[0]*t[3]+t[1]*t[2]),1-2*(t[2]*t[2]+t[3]*t[3]))*d]}function l(t){var e=t[0]*f,a=t[1]*f,n=Math.cos(a);return[n*Math.cos(e),n*Math.sin(e),Math.sin(a)]}function c(t,e){for(var a=0,n=t.length,r=0;a<n;++a)r+=t[a]*e[a];return r}function s(t,e){return[t[1]*e[2]-t[2]*e[1],t[2]*e[0]-t[0]*e[2],t[0]*e[1]-t[1]*e[0]]}function u(t){for(var e=0,a=arguments.length,n=[];++e<a;)n.push(arguments[e]);var r=d3.dispatch.apply(null,n);return r.of=function(e,a){return function(n){try{var o=n.sourceEvent=d3.event;n.target=t,d3.event=n,r[n.type].apply(e,a)}finally{d3.event=o}}},r}var f=Math.PI/180,d=180/Math.PI;d3.geo.zoom=function(){function c(t){g++||t({type:"zoomstart"})}function s(t){t({type:"zoom"})}function f(t){--g||t({type:"zoomend"})}var d,h,p,g=0,m=u(v,"zoomstart","zoom","zoomend"),v=d3.behavior.zoom().on("zoomstart",function(){var o=d3.mouse(this),l=a(d.rotate()),u=e(d,o);u&&(p=u),y.call(v,"zoom",function(){d.scale(b.k=d3.event.scale);var a=d3.mouse(this),c=r(p,e(d,a));d.rotate(b.r=i(l=c?n(l,c):n(t(d,o,a),l))),o=a,s(m.of(this,arguments))}),c(m.of(this,arguments))}).on("zoomend",function(){y.call(v,"zoom",null),f(m.of(this,arguments))}),y=v.on,b={r:[0,0,0],k:1};return v.rotateTo=function(t){var e=r(l(t),l([-b.r[0],-b.r[1]]));return i(n(a(b.r),e))},v.projection=function(t){return arguments.length?(d=t,b={r:d.rotate(),k:d.scale()},v.scale(b.k)):d},v.duration=function(t){return arguments.length?(h=t,v):h},v.event=function(t){t.each(function(){var t=d3.select(this),e=m.of(this,arguments),n=b,r=d3.transition(t);if(r!==t){r.each("start.zoom",function(){this.__chart__&&(b=this.__chart__),d.rotate(b.r).scale(b.k),c(e)}).tween("zoom:zoom",function(){var t=v.size()[0],l=o(a(b.r),a(n.r)),c=d3.geo.distance(b.r,n.r),u=d3.interpolateZoom([0,0,t/b.k],[c,0,t/n.k]);return h&&r.duration(h(.001*u.duration)),function(a){var n=u(a);this.__chart__=b={r:i(l(n[0]/c)),k:t/n[2]},d.rotate(b.r).scale(b.k),v.scale(b.k),s(e)}}).each("end.zoom",function(){f(e)});try{r.each("interrupt.zoom",function(){f(e)})}catch(t){console.log(t)}}else this.__chart__=b,c(e),s(e),f(e)})},d3.rebind(v,m,"on")}}(),q};window.Celestial=makeCelestial();